<style>
.value-savings-banner {
	background: linear-gradient(90deg, #e6f9ee 0%, #d1f2d8 100%);
	border: 1px solid #a8e6b0;
	color: #0d6832;
	font-weight: 500;
	font-size: 0.95rem;
	display: inline-block;
	padding: 6px 10px;
	border-radius: 8px;
	animation: pulse-green 2s infinite;
}
.value-savings-text {
	display: flex;
	align-items: center;
	gap: 4px;
}
@keyframes pulse-green {
	0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.3); }
	70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
	100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

/* PDP CTA Layout Fix */
.pdp-cta-container {
	gap: 10px;
}

@media (max-width: 768px) {
	.pdp-cta-container {
		flex-direction: column;
	}

	.pdp-cta-container .btn {
		width: 100%;
	}
}
/* WhatsApp Button ‚Äì Desktop (default) */
.btn-whatsapp-order {
	border: 1px solid #25D366;
	color: #25D366;
	font-weight: 600;
	background: transparent;
}

/* Desktop hover */
@media (hover: hover) and (pointer: fine) {
	.btn-whatsapp-order:hover {
		background: #25D366;
		color: #fff;
	}
}

/* Mobile ‚Äì Solid Green (no hover) */
@media (max-width: 768px) {
	.btn-whatsapp-order {
		background: #25D366 !important;
		color: #fff !important;
		border: none;
	}
}

/* Warranty / Returns Section */
.pdp-warranty-box {
	background: #f8fafc;
	border: 1px solid #e5e7eb;
	border-radius: 10px;
	padding: 12px 14px;
	margin-top: 16px;
}

.pdp-warranty-item {
	display: flex;
	align-items: center;
	font-size: 14px;
	color: #374151;
	margin-bottom: 6px;
}

.pdp-warranty-item:last-child {
	margin-bottom: 0;
}

.pdp-warranty-item svg {
	margin-right: 8px;
	flex-shrink: 0;
}

.pdp-warranty-title {
	font-weight: 600;
	margin-bottom: 8px;
	font-size: 14px;
	color: #111827;
}
</style>

{% if shopping_cart and shopping_cart.cart_settings.enabled %}

{% set cart_settings = shopping_cart.cart_settings %}
{% set product_info = shopping_cart.product_info %}
{% set whatsapp_number = frappe.db.get_single_value(
	"Karp Webshop Settings",
	"whatsapp_no"
) %}



<div class="item-cart row mt-2" data-variant-item-code="{{ item_code }}">

	<div class="col-md-12">
		{% if cart_settings.show_price and product_info.price %}
			{% set price_info = product_info.price %}

			<div class="product-price" itemprop="offers" itemscope itemtype="https://schema.org/AggregateOffer">

				{% set single_discount = (doc.custom_single_discount or 0) | float %}
				{% set base_price = (price_info.price_list_rate or 0) | float %}
				{% if single_discount > 0 %}
					{% set discounted_price = base_price * (1 - single_discount / 100) %}

					<span class="discounted-price text-red-600 font-semibold ml-2">
						{{ frappe.utils.fmt_money(discounted_price, currency=price_info.currency) }}
					</span>
					<small class="striked-price formatted-price">
						<s>{{ frappe.utils.fmt_money(base_price, currency=price_info.currency) }}</s>
					</small>
					<small class="ml-1 product-info in-green">
						({{ single_discount }}% OFF)
					</small>
				{% else %}
					<span>{{ price_info.formatted_price_sales_uom }}</span>
				{% endif %}

			</div>
			{% if doc.custom_vsp_eligible %}
				<div class="value-savings-banner mt-2 p-2 rounded">
					<span class="value-savings-text">
						Additional Savings With <b>VSP</b>

						<span
							class="ml-1"
							style="cursor: pointer;"
							data-toggle="modal"
							data-target="#vspInfoModal"
							title="Know more about VSP"
						>
							<svg width="16" height="16" fill="#0d6832" viewBox="0 0 16 16">
								<path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm0 11.93A4.93 4.93 0 1 1 8 3.07a4.93 4.93 0 0 1 0 9.86zM7 5h2v2H7V5zm0 3h2v4H7V8z"/>
							</svg>
						</span>
					</span>
				</div>
				<!-- VSP Info Modal -->
				<div class="modal fade" id="vspInfoModal" tabindex="-1" role="dialog" aria-labelledby="vspInfoModalLabel" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 420px;">
						<div class="modal-content" style="border-radius: 12px;">

							<div class="modal-header" style="border-bottom: none;">
								<h6 class="modal-title" id="vspInfoModalLabel" style="font-weight: 600;">
									Value Savings Program (VSP)
								</h6>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>

							<div class="modal-body text-center">
								<img
									src="https://www.klearkut.com/static/imgs/assets/VSP.webp"
									alt="VSP Benefits"
									style="width: 100%; border-radius: 8px;"
								/>
							</div>

							<div class="modal-footer" style="border-top: none;">
								<button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">
									Got it
								</button>
							</div>

						</div>
					</div>
				</div>
			{% endif %}
		{% else %}
			{{ _("UOM") }} : {{ product_info.uom }}
		{% endif %}

		

		<!-- Offers -->
		{% if doc.offers %}
			<br>
			<div class="offers-heading mb-4">
				<span class="mr-1 tag-icon">
					<svg class="icon icon-lg"><use href="#icon-tag"></use></svg>
				</span>
				<b>Available Offers</b>
			</div>
			<div class="offer-container">
				{% for offer in doc.offers %}
				<div class="mt-2 d-flex">
					<div class="mr-2" >
						<svg width="24" height="24" viewBox="0 0 24 24" stroke="var(--yellow-500)" fill="none" xmlns="http://www.w3.org/2000/svg">
							<path d="M19 15.6213C19 15.2235 19.158 14.842 19.4393 14.5607L20.9393 13.0607C21.5251 12.4749 21.5251 11.5251 20.9393 10.9393L19.4393 9.43934C19.158 9.15804 19 8.7765 19 8.37868V6.5C19 5.67157 18.3284 5 17.5 5H15.6213C15.2235 5 14.842 4.84196 14.5607 4.56066L13.0607 3.06066C12.4749 2.47487 11.5251 2.47487 10.9393 3.06066L9.43934 4.56066C9.15804 4.84196 8.7765 5 8.37868 5H6.5C5.67157 5 5 5.67157 5 6.5V8.37868C5 8.7765 4.84196 9.15804 4.56066 9.43934L3.06066 10.9393C2.47487 11.5251 2.47487 12.4749 3.06066 13.0607L4.56066 14.5607C4.84196 14.842 5 15.2235 5 15.6213V17.5C5 18.3284 5.67157 19 6.5 19H8.37868C8.7765 19 9.15804 19.158 9.43934 19.4393L10.9393 20.9393C11.5251 21.5251 12.4749 21.5251 13.0607 20.9393L14.5607 19.4393C14.842 19.158 15.2235 19 15.6213 19H17.5C18.3284 19 19 18.3284 19 17.5V15.6213Z" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
							<path d="M15 9L9 15" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
							<path d="M10.5 9.5C10.5 10.0523 10.0523 10.5 9.5 10.5C8.94772 10.5 8.5 10.0523 8.5 9.5C8.5 8.94772 8.94772 8.5 9.5 8.5C10.0523 8.5 10.5 8.94772 10.5 9.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
							<path d="M15.5 14.5C15.5 15.0523 15.0523 15.5 14.5 15.5C13.9477 15.5 13.5 15.0523 13.5 14.5C13.5 13.9477 13.9477 13.5 14.5 13.5C15.0523 13.5 15.5 13.9477 15.5 14.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
						</svg>
					</div>
					<p class="mr-1 mb-1">
						{{ _(offer.offer_title) }}:
						{{ _(offer.offer_subtitle) if offer.offer_subtitle else '' }}
						<a class="offer-details" href="#"
							data-offer-title="{{ offer.offer_title }}" data-offer-id="{{ offer.name }}"
							role="button">
							{{ _("More") }}
						</a>
					</p>
				</div>
				{% endfor %}
			</div>
		{% endif %}
		
		<!-- Warranty & Returns -->
		<div class="pdp-warranty-box">
			<div class="pdp-warranty-title">
				Warranty & Returns
			</div>

			<div class="pdp-warranty-item">
				<svg width="16" height="16" fill="#16a34a" viewBox="0 0 24 24">
					<path d="M9 16.2l-3.5-3.5L4 14.2l5 5 12-12-1.5-1.5z"/>
				</svg>
				14 Days Adaption Warranty
			</div>

			<div class="pdp-warranty-item">
				<svg width="16" height="16" fill="#16a34a" viewBox="0 0 24 24">
					<path d="M9 16.2l-3.5-3.5L4 14.2l5 5 12-12-1.5-1.5z"/>
				</svg>
				14 Days Return / Exchange
			</div>

			<div class="pdp-warranty-item">
				<svg width="16" height="16" fill="#16a34a" viewBox="0 0 24 24">
					<path d="M9 16.2l-3.5-3.5L4 14.2l5 5 12-12-1.5-1.5z"/>
				</svg>
				1 Year Frame Polish Warranty
			</div>

			<div class="pdp-warranty-item">
				<svg width="16" height="16" fill="#16a34a" viewBox="0 0 24 24">
					<path d="M9 16.2l-3.5-3.5L4 14.2l5 5 12-12-1.5-1.5z"/>
				</svg>
				1 Year Lens Coating Peel Warranty
			</div>
		</div>
		{% if doc.custom_hto_eligible %}
			<!-- Home Try-On Badge (Hidden by default, shown by JS if hse=true) -->
			<div id="hse-pdp-badge" class="home-service-badge mt-3">
				<span style="font-size: 14px; font-weight: 600;">
					üè† Eligible for Home Try-On
				</span>

				<span class="ml-2" style="cursor: pointer;" data-toggle="modal" data-target="#homeTryOnModal">
					<svg width="16" height="16" fill="#6c757d" viewBox="0 0 16 16">
						<path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm0 11.93A4.93 4.93 0 1 1 8 3.07a4.93 4.93 0 0 1 0 9.86zM7 5h2v2H7V5zm0 3h2v4H7V8z"/>
					</svg>
				</span>
			</div>

			<!-- Home Try-On Info Modal -->
			<div class="modal fade" id="homeTryOnModal" tabindex="-1" role="dialog" aria-labelledby="homeTryOnModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 360px;">
					<div class="modal-content" style="border-radius: 12px;">
					
						<div class="modal-header" style="border-bottom: none;">
							<h6 class="modal-title" id="homeTryOnModalLabel" style="font-weight: 600;">
								Home Try-On Available
							</h6>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="outline: none;">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>

						<div class="modal-body" style="font-size: 14px; color: #555; line-height: 1.5;">
							Our optician will bring this frame to your home during your lens consultation or 
							eye checkup. You can try it before finalizing your order. Completely risk-free. 
							Location Restriction Apply.
						</div>

						<div class="modal-footer" style="border-top: none;">
							<button type="button" class="btn btn-primary btn-sm" data-dismiss="modal" style="border-radius: 6px;">
								Got it
							</button>
						</div>

					</div>
				</div>
			</div>
		{% endif %}
		{% if cart_settings.show_stock_availability %}
		<div class="mt-2">
			{% if product_info.get("on_backorder") %}
				<span class="no-stock out-of-stock" style="color: var(--primary-color);">
					{{ _('Available on backorder') }}
				</span>
			{% elif product_info.in_stock == 0 %}
				<span class="no-stock out-of-stock">
					{{ _('Out of stock') }}
				</span>
			{% elif product_info.in_stock == 1 %}
				<span class="in-green has-stock">
					{{ _('In stock') }}
					<!--{% if product_info.show_stock_qty and product_info.stock_qty %}
						({{ product_info.stock_qty }})
					{% endif %}-->
				</span>
			{% endif %}
		</div>
		{% endif %}

		<!-- Add to Cart / View in Cart, Contact Us -->
		<div class="mt-6 mb-5">
			<div class="mb-4 d-flex flex-wrap pdp-cta-container">
				<!-- Add to Cart -->
				{% if product_info.price and (cart_settings.allow_items_not_in_stock or product_info.get("in_stock")) %}
					<a href="/cart" class="btn btn-light btn-view-in-cart hidden mr-2 font-md"
						role="button">
						{{  _("View in Cart") if cart_settings.enable_checkout else _("View in Quote") }}
					</a>
					<button
						data-item-code="{{item_code}}"
						class="btn btn-primary btn-add-to-cart mr-2"
					>
						<span class="mr-2">
							<svg class="icon icon-md">
								<use href="#icon-assets"></use>
							</svg>
						</span>
						{{ _("Add to Cart") if cart_settings.enable_checkout else  _("Add to Quote") }}
					</button>
					<button
						type="button"
						class="btn btn-outline-success btn-whatsapp-order mt-2"
						data-item-name="{{ doc.item_name }}"
						data-item-code="{{ item_code }}"
						data-item-price="{{ price_info.formatted_price_sales_uom if price_info else '' }}"
						data-whatsapp="{{ whatsapp_number | replace('+','') }}"
						>
						<span class="mr-2">
							<svg width="18" height="18" viewBox="0 0 32 32" fill="#25D366">
							<path d="M16 0C7.164 0 0 7.164 0 16c0 2.82.734 5.465 2.02 7.77L0 32l8.438-1.969A15.93 15.93 0 0 0 16 32c8.836 0 16-7.164 16-16S24.836 0 16 0z"/>
							</svg>
						</span>
						Order on WhatsApp
					</button>
				{% endif %}

				<!-- Contact Us -->
				{% if cart_settings.show_contact_us_button %}
					{% include "templates/generators/item/item_inquiry.html" %}
				{% endif %}
			</div>
		</div>
	</div>
</div>

<script>
	frappe.ready(() => {
		$('.page_content').on('click', '.btn-add-to-cart', (e) => {
			// Bind action on add to cart button
			const $btn = $(e.currentTarget);
			$btn.prop('disabled', true);
			const item_code = $btn.data('item-code');
			webshop.webshop.shopping_cart.update_cart({
				item_code,
				qty: 1,
				callback(r) {
					$btn.prop('disabled', false);
					if (r.message) {
						$('.btn-add-to-cart, .btn-view-in-cart').toggleClass('hidden');
						// ---------------------------------------------
                        // GA4 Add to Cart Event
                        // ---------------------------------------------
                        dataLayer.push({
                            event: "add_to_cart",
                            ecommerce: {
                                currency: "{{ price_info.currency }}",
                                value: {{ (price_info.price_list_rate or 0) | float }},
                                items: [{
                                    item_id: "{{ item_code }}",
                                    item_name: "{{ doc.item_name }}",
                                    item_brand: "{{ doc.brand }}",
                                    item_category: "{{ doc.item_group }}",
                                    price: {{ (price_info.price_list_rate or 0) | float }},
                                    quantity: 1
                                }]
                            }
                        });
					}
				}
			});
		});

		$('.page_content').on('click', '.offer-details', (e) => {
			// Bind action on More link in Offers
			const $btn = $(e.currentTarget);
			$btn.prop('disabled', true);

			var d = new frappe.ui.Dialog({
				title: __($btn.data('offer-title')),
				fields: [
					{
						fieldname: 'offer_details',
						fieldtype: 'HTML'
					},
					{
						fieldname: 'section_break',
						fieldtype: 'Section Break'
					}
				]
			});

			frappe.call({
				method: 'webshop.webshop.doctype.website_offer.website_offer.get_offer_details',
				args: {
					offer_id: $btn.data('offer-id')
				},
				callback: (value) => {
					d.set_value("offer_details", value.message);
					d.show();
					$btn.prop('disabled', false);
				}
			})

		});
		// ---------------------------------------------
		// Order on WhatsApp (PDP)
		// ---------------------------------------------
		$('.page_content').on('click', '.btn-whatsapp-order', function () {

		const itemName = $(this).data('item-name');
		const itemCode = $(this).data('item-code');
		const price = $(this).data('item-price');
		const productUrl = window.location.href;
		const phone = $(this).data('whatsapp');
		if (!phone) {
			alert("WhatsApp number not configured.");
			return;
		}

		let message =
			`Hi, I want to order this product:%0A%0A` +
			`Product: ${itemName}%0A` +
			`Item Code: ${itemCode}%0A` +
			(price ? `Price: ${price}%0A` : ``) +
			`Link: ${productUrl}%0A%0A` +
			`Please assist me.`;

		const waUrl = `https://wa.me/${phone}?text=${message}`;

		window.open(waUrl, "_blank");
		

		if (typeof dataLayer !== "undefined") {
			dataLayer.push({
			event: "whatsapp_pdp_click",
			item_id: itemCode,
			item_name: itemName
			});
		}
		});
	});


</script>

<!--<script>
	document.addEventListener("DOMContentLoaded", function () {
    const hse = document.cookie.split('; ')
        .find(row => row.startsWith('hse='))
        ?.split('=')[1];

    if (hse === "true") {
        const el = document.getElementById("hse-pdp-badge");
        if (el) {
            el.style.display = "flex";        // show
            el.style.alignItems = "center";   // align content like before
        }
    }
});
</script>-->

{% endif %}
