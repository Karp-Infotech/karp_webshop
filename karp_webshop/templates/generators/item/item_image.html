{% set column_size = 5 if slides else 4 %}
<div class="col-md-{{ column_size }} h-100 d-flex mb-4">
	{% if slides %}
		<div class="item-slideshow d-flex flex-column mr-3">
			{% for item in slides %}
			<img class="item-slideshow-image mb-2 {% if loop.first %}active{% endif %}"
					src="{{ item.image }}" alt="{{ item.heading }}">
			{% endfor %}
		</div>
		{{ product_image(slides[0].image, 'product-image') }}
		<!-- Simple image slideshow -->
		<script>
			frappe.ready(() => {
				$('.page_content').on('click', '.item-slideshow-image', (e) => {
					const $img = $(e.currentTarget);
					const link = $img.prop('src');
					const $product_image = $('.product-image');
					$product_image.find('a').prop('href', link);
					$product_image.find('img').prop('src', link);

					$('.item-slideshow-image').removeClass('active');
					$img.addClass('active');
				});
			})
		</script>
	{% else %}
		{{ product_image(doc.website_image, alt=doc.website_image_alt or doc.item_name) }}
	{% endif %}

	<!-- Simple image preview -->

	<div class="image-zoom-view" style="display: none;">
		<button type="button" class="close" aria-label="Close">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
			stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x">
				<line x1="18" y1="6" x2="6" y2="18"></line>
				<line x1="6" y1="6" x2="18" y2="18"></line>
			</svg>
		</button>
	</div>
</div>
<style>
	.website-image {
		cursor: pointer;
	}

	.image-zoom-view {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		height: 100vh;
		width: 100vw;
		display: flex;
		justify-content: center;
		align-items: center;
		background: rgba(0, 0, 0, 0.8);
		z-index: 1080;
	}

	.image-zoom-view img {
		max-height: 100%;
		max-width: 100%;
	}

	.image-zoom-view button {
		position: absolute;
		right: 3rem;
		top: 2rem;
	}

	.image-zoom-view svg {
		color: var(--white);
	}
</style>

<script>
frappe.ready(() => {
  const $zoom_wrapper = $('.image-zoom-view');
  const $thumbnails = $('.item-slideshow-image'); // thumbnail images
  const $product_image = $('.product-image'); // main product image wrapper

  // Build an ordered array of srcs from thumbnails (fallback to main image if no thumbnails)
  function getImageList() {
    const list = [];
    $thumbnails.each(function () {
      const s = $(this).prop('src');
      if (s) list.push(s);
    });
    // if no thumbnails, try main image
    if (!list.length) {
      const main = $product_image.find('img').first().prop('src');
      if (main) list.push(main);
    }
    return list;
  }

  // helper to set active thumbnail by src
  function setActiveThumbnailBySrc(src) {
    $thumbnails.removeClass('active');
    $thumbnails.filter(function () {
      return $(this).prop('src') === src;
    }).first().addClass('active');
  }

  // Update main product image (used when clicking a thumbnail normally)
  function setMainImage(src) {
    $product_image.find('a').prop('href', src);
    $product_image.find('img').prop('src', src);
  }

  // Replace zoom image src (if zoom open) or open zoom for src
  function setZoomImage(src) {
    // if already a zoom img, replace src, else append new img
    const $existing = $zoom_wrapper.find('img');
    if ($existing.length) {
      $existing.prop('src', src);
    } else {
      const $img = $(`<img src="${src}">`);
      $zoom_wrapper.append($img);
    }
  }

  // Show preview overlay
  function show_preview(src) {
    $zoom_wrapper.show();
    setZoomImage(src);
  }

  // Hide preview overlay
  function hide_preview() {
    $zoom_wrapper.find('img').remove();
    $zoom_wrapper.hide();
  }

  // Return index in image list for a src
  function indexOfSrc(src, list) {
    for (let i = 0; i < list.length; i++) {
      if (list[i] === src) return i;
    }
    return -1;
  }

  // Move to next/prev image while zoom open
  function moveZoomBy(delta) {
    const list = getImageList();
    const $cur = $zoom_wrapper.find('img').first();
    if (!$cur.length) return;
    const curSrc = $cur.prop('src');
    let idx = indexOfSrc(curSrc, list);
    if (idx === -1) {
      // if not found, fallback to first
      idx = 0;
    }
    let nextIdx = (idx + delta + list.length) % list.length;
    const nextSrc = list[nextIdx];
    if (nextSrc) {
      setZoomImage(nextSrc);
      setActiveThumbnailBySrc(nextSrc);
      setMainImage(nextSrc); // also keep main image synced
    }
  }

  // Thumbnail click: swap main image, and if zoom is open update zoom image too
  $('.page_content').on('click', '.item-slideshow-image', (e) => {
    const $img = $(e.currentTarget);
    const link = $img.prop('src');

    // update main product image
    setMainImage(link);

    // mark active thumbnail
    $('.item-slideshow-image').removeClass('active');
    $img.addClass('active');

    // if zoom overlay visible, swap zoom image instead of closing it
    if ($zoom_wrapper.is(':visible')) {
      setZoomImage(link);
    }
  });

  // Click on main image: open zoom
  $('.page_content').on('click', '.website-image', (e) => {
    e.preventDefault();
    const $img = $(e.target);
    const src = $img.prop('src');
    if (!src) return;
    show_preview(src);
  });

  // Close button
  $zoom_wrapper.on('click', 'button', (e) => {
    e.stopPropagation();
    hide_preview();
  });

  // Keyboard handling for Escape and arrow navigation
  $(document).on('keydown', (e) => {
    if (e.key === 'Escape') {
      hide_preview();
    } else if (e.key === 'ArrowRight') {
      if ($zoom_wrapper.is(':visible')) {
        moveZoomBy(1);
      }
    } else if (e.key === 'ArrowLeft') {
      if ($zoom_wrapper.is(':visible')) {
        moveZoomBy(-1);
      }
    }
  });

  // Click outside image in overlay closes it (optional) â€” keep user-friendly
  $zoom_wrapper.on('click', (e) => {
    // if clicked directly on overlay (not image), close
    if ($(e.target).is('.image-zoom-view')) {
      hide_preview();
    }
  });

  // Optional: handle clicks on the zoom image itself to go next
  $zoom_wrapper.on('click', 'img', (e) => {
    // Click on the zoomed image goes to next image
    moveZoomBy(1);
  });
});
</script>
