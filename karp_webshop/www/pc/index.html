<script defer src="/assets/karp_webshop/js/product_ui/karp_grid.js"></script>

<link rel="stylesheet" type="text/css" href="/assets/karp_webshop/css/pc.css">

{% from "webshop/templates/includes/macros.html" import attribute_filter_section, field_filter_section, discount_range_filters %}
{% extends "templates/web.html" %}

{% block title %}
  {{ pc.seo_title or title }}
{% endblock %}
{% block meta_block %}

  {% set has_filters = frappe.form_dict and frappe.form_dict|length > 0 %}

  <link rel="canonical" href="{{ pc.canonical_url or frappe.utils.get_url(pc.route) }}">

  {% if pc.meta_description %}
  <meta name="description" content="{{ pc.meta_description }}">
  {% endif %}

  {% if not pc.allow_indexing or has_filters %}
  <meta name="robots" content="noindex, follow">
  {% else %}
  <meta name="robots" content="index, follow">
  {% endif %}

  {# Optional: OpenGraph / Twitter consistency #}
  <meta property="og:title" content="{{ pc.seo_title or title }}">
  {% if pc.meta_description %}
  <meta property="og:description" content="{{ pc.meta_description }}">
  {% endif %}
  <meta property="og:url" content="{{ pc.canonical_url or frappe.utils.get_url(pc.route) }}">
  <meta property="og:type" content="website">

  {# Collection Schema (optional but recommended) #}
  {% if pc.schema_json %}
  <script type="application/ld+json">
  {{ pc.schema_json | safe }}
  </script>
  {% endif %}
{% endblock %}

{% block header %}
{% if pc.cover_img %}
  {# Cover image shown, H1 kept for SEO but visually subtle #}
  <h1 class="pc-title sr-only">
    {{ pc.h1_override or pc.title or title }}
  </h1>
{% else %}
  {# No cover image, show H1 normally #}
  <h1 class="pc-title">
    {{ pc.h1_override or pc.title or title }}
  </h1>
{% endif %}
{% endblock %}

{% block page_content %}
{% if pc.cover_img %}
<div class="collection-cover">
  <picture>
    {# Mobile image first (max-width rule) #}
    {% if pc.cover_img_mobile %}
    <source
      srcset="{{ pc.cover_img_mobile }}"
      media="(max-width: 767px)">
    {% endif %}

    {# Desktop fallback #}
    <img
      src="{{ pc.cover_img }}"
      alt="{{ pc.seo_title or pc.title }}"
      loading="lazy"
      width="1600"
      height="600"
      decoding="async"
    >
  </picture>

</div>
{% endif %}
<input type="hidden" id="pc_field_filters" value='{{ field_filter | tojson | safe }}'>
<div class="row">


	<!-- Items section -->
	<div id="product-listing" class="col-12 order-2 col-md-9 order-md-2 item-card-group-section">
		<!-- Rendered via JS -->
	</div>

		<!-- Mobile Filter Button (visible on small screens only) -->
<div class="d-md-none mb-3">
  <button id="mobile-filter-btn" class="btn btn-outline-secondary" type="button" aria-label="Open filters">
    <svg style="width:18px;height:18px;vertical-align:middle;" aria-hidden="true"><use href="#icon-filter"></use></svg>
    <span style="margin-left:8px;">{{ _('Filters') }}</span>
  </button>
</div>

<!-- Mobile Off-canvas Drawer -->
<div id="mobile-filter-drawer" class="mobile-filter-drawer" aria-hidden="true" style="display:none;">
  <div class="mobile-filter-backdrop" role="button" tabindex="0" aria-label="Close filters"></div>
  <div class="mobile-filter-panel" role="dialog" aria-modal="true">
    <div class="mobile-filter-header d-flex justify-content-between align-items-center mb-3">
      <button id="mobile-filter-close" class="btn btn-sm btn-link" aria-label="Close filters">Close</button>
    </div>
    <div class="mobile-filter-body">
      <!-- cloned filters are injected here -->
    </div>
    <div class="mobile-filter-footer d-flex justify-content-between mt-3">
      <button id="mobile-filter-clear" class="btn btn-light">{{ _('Clear') }}</button>
      <button id="mobile-filter-apply" class="btn btn-primary">{{ _('Apply') }}</button>
    </div>
  </div>
</div>


	<!-- Filters Section -->
	<div class="col-12 order-1 col-md-3 order-md-1">
		<div class="collapse d-md-block mr-4 filters-section" id="product-filters">
			<div class="d-flex justify-content-between align-items-center mb-5 title-section">
				<div class="mb-4 filters-title" > {{ _('Filters') }} </div>
				<a class="mb-4 clear-filters" href='{{ frappe.request.url }}'>{{ _('Clear All') }}</a>
			</div>
			<!-- field filters -->
			{% if field_filters %}
				{{ field_filter_section(field_filters) }}
			{% endif %}

			<!-- attribute filters -->
			{% if attribute_filters %}
				{{ attribute_filter_section(attribute_filters) }}
			{% endif %}
		</div>

	</div>
</div>
<!-- VSP Info Modal -->
				<div class="modal fade" id="vspInfoModal" tabindex="-1" role="dialog" aria-labelledby="vspInfoModalLabel" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 420px;">
						<div class="modal-content" style="border-radius: 12px;">

							<div class="modal-header" style="border-bottom: none;">
								<h6 class="modal-title" id="vspInfoModalLabel" style="font-weight: 600;">
									Value Savings Program (VSP)
								</h6>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>

							<div class="modal-body text-center">
								<img
									src="https://www.klearkut.com/static/imgs/assets/VSP.webp"
									alt="VSP Benefits"
									style="width: 100%; border-radius: 8px;"
								/>
							</div>

							<div class="modal-footer" style="border-top: none;">
								<button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">
									Got it
								</button>
							</div>

						</div>
					</div>
				</div>

<script>
	frappe.ready(() => {
		$('.btn-prev, .btn-next').click((e) => {
			const $btn = $(e.target);
			$btn.prop('disabled', true);
			const start = $btn.data('start');
			let query_params = frappe.utils.get_query_params();
			query_params.start = start;
			let path = window.location.pathname + '?' + frappe.utils.get_url_from_dict(query_params);
			window.location.href = path;
		});
	});
</script>

<script>

let vtoStarted = false;

// Listen to postMessage from iframe
window.addEventListener('message', (event) => {
    const data = event.data;
    if (data && data.type === 'vto-started') {
        vtoStarted = true;
    }
});
function openVtoInstructions(itemCode) {
    const url = `/vto-instructions?ic=${encodeURIComponent(itemCode)}`;

    frappe.web_form_dialog = new frappe.ui.Dialog({
        title: "Virtual Try-On",
        size: "large"
    });

    frappe.web_form_dialog.$body.html(`
        <iframe id="vtoFrame" src="${url}"
                style="width:100%; height:80vh; border:0;"></iframe>
    `);

    // â­ Only go back if VTO (camera) page was actually opened.
    frappe.web_form_dialog.onhide = () => {
         if (vtoStarted) {
          history.back();
          vtoStarted = false; // reset flag for next time
      }
    };

    frappe.web_form_dialog.show();
}
</script>


{% endblock %}


